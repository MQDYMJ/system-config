#!/bin/bash
set -e

if my-adb shell 'which busybox && which bash && echo yes' |grep -q yes; then
    true
else
    busybox_file=~/system-config/doc/galaxy-nexus-root/system/xbin/busybox
    bash_file=~/system-config/doc/galaxy-nexus-root/system/xbin/bash
    adb push $busybox_file /system/xbin/$(basename $busybox_file)
    adb push $bash_file /system/xbin/$(basename $bash_file)
    my-adb shell "chmod 755 /system/xbin/*"
fi

applets=$(
    my-adb shell busybox | perl -ne 'print if m/Currently defined functions:/..0' | perl -ne 's/,//g; print unless 1..1'
)

(
    echo cd /system/xbin/
    echo 'busybox=$(busybox which busybox)'
    for x in $applets; do
        echo busybox ln -sf \$busybox "$x"
    done
) > /tmp/ln.sh.$$
adb push /tmp/ln.sh.$$ /sdcard/ln.sh
adb shell sh -x /sdcard/ln.sh



