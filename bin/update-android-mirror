#!/bin/bash
set -ex

. ~/system-config/.bashrc
. ~/system-config/bin/set-ssh-agent


(
    cd ~/src/android-mirror/ || exit 0
    if ! is-tty-io; then
        (
            cd ~/src/android-mirror/kernel/msm.git || exit 0
            git fetch https://github.com/mirrors/linux
        ) || true
    fi

    export http_proxy=http://localhost:8888
    export https_proxy=http://localhost:8888
    repo-switch -u https://android.googlesource.com/platform/manifest -b master -m default.xml
    if repo sync -j1 -f; then
        my-rfa '(pwd; git push --no-thin s:qualcomm/$(repo-project) refs/heads/*:refs/heads/* 2>&1)|tee git-push.txt'
        if my-rfa 'grep rejected git-push.txt -q && pwd' | grep .; then
            my-rfa 'grep rejected git-push.txt -q && pwd' | mailx baohaojun@gmail.com -s "Some android branches failed to sync"
        fi
    else
        day=$(today +%d|perl -npe 's/^0*//')
        if (( day % 5 == 1 )); then
            mailx baohaojun@gmail.com -s "Android mirror failed to sync" </dev/null
        fi
    fi
)

echo ok, repo update complete
