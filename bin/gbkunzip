#!/bin/bash
set -e

[[ "$1" =~ .zip$ ]]
FILE=`readlink -f "$1"`
DIR=${FILE##*/}.$$

mkdir -p "$DIR"

TD=$DIR.td
mkdir $TD

(
    cd $TD

    check-program 7za p7zip

    7za x "$FILE" &>/dev/null
    convmv -f gbk -t utf8 -r --notest -- * &>/dev/null
)
mv $TD/* "$DIR" -v
rmdir $TD
cd "$DIR"
fix-deep-dirs
