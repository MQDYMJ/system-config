#!/bin/bash

set -e
function die() {
    echo Error: "$@"
    exit -1
}


# When called, we must be at the top of the beagrep indexed source folder.

source_dir=$(readlink -f .)
export db_dir=~/.cache/for-code-reading/$source_dir

## start code-generator "^\\s *#\\s *"
# generate-getopts e:entry iignore_case p:path_pat w:working_file t:type
## end code-generator
## start generated code
entry=
ignore_case=false
path_pat=
working_file=
type=
OPTIND=1
while getopts 'e:ip:w:t:' opt; do
    case "$opt" in
        e)    entry=$OPTARG;;
        i)    ignore_case=true;;
        p)    path_pat=$OPTARG;;
        w)    working_file=$OPTARG;;
        t)    type=$OPTARG;;
        *)    echo Usage Error;;
    esac
done
shift $(($OPTIND - 1))

## end generated code


if test ! "$entry"; then
    die "Usage: beatags -e ENTRY [-i]"
fi

quote=-q
if [[ "$entry" =~ \* ]]; then
    quote=
fi

if test -e "$working_file"; then
    echo "$working_file"
else
    beagrep-files -t $quote -s "$entry"
fi| grep -v -P -e '[ \t]' |
    if test "$path_pat"; then
        grep -P -e "$path_pat";
    else
        cat
    fi|
    beatags-timestamp |
    xargs cat /dev/null |
    grep $(if test $ignore_case = true; then echo -i; fi) -P -e "^\\S*?\\b$entry\\s+" |
    if test "$type"; then
        grep -P -e "^\S+\s+($type)\s+\d+"
    else
        cat
    fi
