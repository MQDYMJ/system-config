#!/bin/bash


## start code-generator "^\\s *#\\s *"
# generate-getopt -e @scaling=false
## end code-generator
## start generated code
TEMP=$( getopt -o h \
               --long scaling,help,no-scaling \
               -n $(basename -- $0) -- "$@")
scaling=${scaling:-false}
eval set -- "$TEMP"
while true; do
    case "$1" in

        --scaling|--no-scaling)
            if test "$1" = --no-scaling; then
                scaling=false
            else
                scaling=true
            fi
            shift
            ;;
        -h|--help)
            set +x
            echo -e
            echo
            echo Options and arguments:
            printf "%06s" " "
            printf %-24s '--[no-]scaling'
            echo
            exit
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            die "internal error"
            ;;
    esac
done


export scaling

## end generated code


true_size=$(my-adb dumpsys window|grep -o -P 'app=\d+x\d+')

if test "$scaling" = false -a "$true_size" != "app=1080x1920" && yes-or-no-p -y "Need scaling: $true_size, use scaling?"; then
    scaling=true
fi

export TAP=adb-tap
if test "$1"; then
    export TAP=$1
fi

(sleep 5) >/dev/null 2>&1 & # to make it safe with Lenovo A360t?
adb-tty getevent -l </dev/tty | perl -ne '
    BEGIN {
        if ($ENV{scaling} eq "false") {
            $true_x = 1080;
            $true_y = 1920;
        } else {
            $xy = qx(my-adb dumpsys window);
            if ($xy =~ m/app=(\d+)x(\d+)/) {
              $true_x = $1;
              $true_y = $2;
            }
        }
    }
    if (m/ABS_MT_POSITION_/) {
        chomp;
        @fields = split;
        ($name, $val) = @fields[2,3];
        $val = hex($val);
        # print "$name: $val\r\n";
        if ($name =~ m/ABS_MT_POSITION_X/) {
            $x = int($val * 1080 / $true_x);
        } elsif ($name =~ m/ABS_MT_POSITION_Y/) {
            $y = int($val * 1920 / $true_y);
        }
        print "$ENV{TAP} $x $y\r\n";
        system("putclip $ENV{TAP} $x $y");
    }
'
