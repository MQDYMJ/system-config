#!/bin/bash

if test "$#" != 0; then
    text=$(echo $*)
else

    top_window=$(sawfish-top-window)
    if test "$top_window" = Wrench; then
        text=$(getclip-android)
    else
        text=$(xclip -o -selection primary)
    fi
fi
text=$(echo -n "$text"|perl -npe 's/(……」|』、『|、|……。|。|！|……|」|』)$//')
(
    text=$(echo -n "$text" | perl -npe 's/^\s*//; s/\s*$//')
    if [[ $text =~ ^https?:// ]]; then
      firefox -current-tab "$text"
    elif echo "$text" | perl -ne 'exit 1 unless m/^\p{ASCII}*$/'; then
        search-dict "$text"
    else
        if ! grep -q "$text" /usr/share/gjiten/dics/*; then
            case "$text" in
                *ん)
                    text=${text}だ
                    ;;
                *っ|*い|*し)
                    text=${text}た
                    ;;
                ## start code-generator "^\\s *#"
                # # {%sh-mode%}
                # : map [あ]=う [か]=く [き]=く [く]=い [なかった]=ない [さ]=す [た]=つ [な]=ぬ
                # : map [は]=ふ [ば]=ぶ [ま]=む [み]=む [や]=ゆ [ら]=る [り]=る [わ]=う
                # cat ~/system-config/bin/s-dicts | grep ': map' |
                #     perl -ne 'while (m/\[(.*?)\]=(.*?) /g) {print "$1 $2\n"}' |
                #     while read from to; do
                # cat <<EOF
                # *$from)
                # text=\${text%$from}${to}
                # ;;
                #EOF
                # done
                #
                # # {%/sh-mode%}
                ## end code-generator
                ## start generated code
                *あ)
                    text=${text%あ}う
                    ;;
                *か)
                    text=${text%か}く
                    ;;
                *き)
                    text=${text%き}く
                    ;;
                *く)
                    text=${text%く}い
                    ;;
                *なかった)
                    text=${text%なかった}ない
                    ;;
                *さ)
                    text=${text%さ}す
                    ;;
                *た)
                    text=${text%た}つ
                    ;;
                *は)
                    text=${text%は}ふ
                    ;;
                *ば)
                    text=${text%ば}ぶ
                    ;;
                *ま)
                    text=${text%ま}む
                    ;;
                *み)
                    text=${text%み}む
                    ;;
                *や)
                    text=${text%や}ゆ
                    ;;
                *ら)
                    text=${text%ら}る
                    ;;
                *り)
                    text=${text%り}る
                    ;;

                ## end generated code
            esac
        fi
        search-gjiten "$text"

    fi&
) 9> /dev/null
exit
