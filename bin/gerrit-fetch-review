#!/bin/bash
set -e
tmpf=/tmp/$(basename $0).$$
if test $# = 1 -a "${1:0:4}" = http; then
    set -- "$(basename "$1")"
fi
gerrit query "$@" --current-patch-set > $tmpf

function die() {
    echo "$@"
    exit -1
}


export PROJECT=$(cat $tmpf|grep 'project: '|pn 2)

git_dir=$(my-rfa 'if [[ $PROJECT =~ $(repo-project)$ ]]; then pwd; fi')

if test -n "$git_dir"; then
    cd $(lookup-file .repo/..) || die repo not found.
    cd $git_dir || die "$git_dir: cd failed"
fi
ref=$(cat $tmpf|grep 'ref: '|pn 2|tail -n 1)
git fetch $(repo-remote-url) $ref
if test $(basename $0) = gerrit-checkout-review; then
    git co FETCH_HEAD
fi
