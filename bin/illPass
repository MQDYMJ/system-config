#!/bin/bash

export EMACS=t
window_class=$(sawfish-top-window-class)
window_name=$(sawfish-top-window-name)

window_class=${window_class,,}
window_name=${window_name,,}

if test "${window_name}" = myscr -a "${window_class}" = xterm; then
    who_and_where=$(
        tmux capture-pane; tmux save-buffer - | reverse | grep '(\S+@\S+)\s' -o -P | head -n 1|tr -d ' '
                 )
    if test "${who_and_where}"; then
        window_class=${who_and_where#*@}
        window_name=${who_and_where%@*}
    fi
fi

IFS=$'\n'
passwords=$(
    cd ~/.password-store/
    find "${window_class}/${window_name}" -type f|perl -pe 's,\.gpg$,,'
         )

declare -A password_map
for password in ${passwords}; do
    password_map[$password]=1
done

which_password=$(select-args -o -p "Which password do you want to use?" $passwords "Add a new password by inputing 'NEW-PASSWORD-NAME!<return>'")

if test "${password_map[$which_password]}" != 1; then
    bhj-notify illPass "需要创建一个新的密码，请输入这个密码的名字（可以是它的用途，比如 sudo 等）"
    which_password=$(ask-for-input-with-sawfish -p "请输入新的密码的名字")
    which_password="${window_class}/${window_name}/${which_password}"
    pass edit $which_password
fi

password=$(
    pass "${which_password}"
        )

xdotool-when-keyboard-clear type "${password}"
