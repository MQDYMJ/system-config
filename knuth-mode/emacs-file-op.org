#+title: 用 emacs 进行一些文件操作

具体的思路是这样的，我自己经常写一些比如：
#+BEGIN_SRC sh
cat f1 f2 > f3 # 也可能是 >>，append
echo x1 x2 > fx

#+END_SRC

这种操作有个问题，就是如果我的 f3、fx 当前是在 emacs 里打开着的，尤其是并且有改动的话，后续就麻烦了，搞不好改动就全丢了。所以希望改成用 emacs 自己来执行这几个操作。

以后，我希望可以这样搞：

#+BEGIN_SRC sh
emacs-file-op cat f1 f2 '>' f3
emacs-file-op echo x1 x2 '>' fx
#+END_SRC

#+name: emacs-append.el
#+BEGIN_SRC elisp
  (progn
    (find-file "$to_file")
    (goto-char (point-max))
    (insert-file "$from_file")
    (save-buffer))
#+END_SRC
** 最终的版本：

#+name: read-only
#+BEGIN_SRC sh
# Local Variables: #
# eval: (read-only-mode 1) #
# End: #
#+END_SRC

#+name: old-code
#+BEGIN_SRC sh

  ## start code-generator "^\\s *#\\s *"
  # generate-getopt f:from-file t:to-file
  ## end code-generator
  ## start generated code
  TEMP=$( getopt -o f:t:h \
                 --long from-file:,to_file:,help \
                 -n $(basename -- $0) -- "$@")
  declare from_file=
  declare to_file=
  eval set -- "$TEMP"
  while true; do
      case "$1" in

          -f|--from-file)
              from_file=$2
              shift 2

              ;;
          -t|--to_file)
              to_file=$2
              shift 2

              ;;
          -h|--help)
              set +x
              echo -e
              echo
              echo Options and arguments:
              printf %06s '-f, '
              printf %-24s '--from-file=FROM_FILE'
              echo
              printf %06s '-t, '
              printf %-24s '--to_file=TO_FILE'
              echo
              exit
              shift
              ;;
          --)
              shift
              break
              ;;
          ,*)
              die "internal error"
              ;;
      esac
  done


  ## end generated code

  if test ! -e "$from_file"; then
      die "FROM-FILE $from_file non-exist"
  fi

  if test ! -e "$to_file"; then
      die "TO-FILE $to_file non-exist"
  fi

  emacsclient -e "$(cat <<EOF16d93b20dc6b
  <<emacs-append.el>>
  EOF16d93b20dc6b
  )"
#+END_SRC

#+name: the-ultimate-script
#+BEGIN_SRC sh :tangle ~/system-config/bin/emacs-file-op :comments link :shebang "#!/bin/bash" :noweb yes
set -e

<<old-code>>
<<read-only>>
#+END_SRC

#+results: the-ultimate-script

